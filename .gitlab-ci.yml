# GitLab CI/CD 配置文件
# 适用于 GitLab 自托管或 GitLab.com

stages:
  - build
  - release

variables:
  FLUTTER_VERSION: "3.24.0"  # 根据项目需要调整
  FLUTTER_CHANNEL: "stable"

# 缓存 Flutter SDK
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .flutter/
    - .pub-cache/

# 构建 Android APK (开发环境)
build-android-dev:
  stage: build
  image: cirrusci/flutter:stable
  script:
    - flutter doctor -v
    - flutter pub get
    - flutter build apk --flavor env_dev -t lib/main_env_dev.dart --target-platform android-arm,android-arm64 --no-tree-shake-icons --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/*.apk
    expire_in: 7 days
  only:
    - develop
    - /^feature\/.*$/

# 构建 Android APK (测试环境)
build-android-test:
  stage: build
  image: cirrusci/flutter:stable
  script:
    - flutter doctor -v
    - flutter pub get
    - flutter build apk --flavor env_test -t lib/main_env_test.dart --target-platform android-arm,android-arm64 --no-tree-shake-icons --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/*.apk
    expire_in: 30 days
  only:
    - test
    - tags

# 构建 Android APK (生产环境)
build-android-release:
  stage: build
  image: cirrusci/flutter:stable
  script:
    - flutter doctor -v
    - flutter pub get
    - |
      VERSION=$(grep -E '^version:' pubspec.yaml | sed 's/version: //')
      VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
      BUILD_NUMBER=$(echo $VERSION | cut -d'+' -f2)
      echo "构建版本: $VERSION_NAME (构建号: $BUILD_NUMBER)"
    - flutter build apk --flavor env_release -t lib/main_env_release.dart --target-platform android-arm,android-arm64 --no-tree-shake-icons --release
    - flutter build appbundle --flavor env_release -t lib/main_env_release.dart --no-tree-shake-icons --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/bundle/**/*.aab
    expire_in: 90 days
    name: "app-release-$CI_COMMIT_TAG"
  only:
    - tags
    - main
  when: manual  # 需要手动触发生产环境构建

# 构建 Android App Bundle (生产环境)
build-android-bundle:
  stage: build
  image: cirrusci/flutter:stable
  script:
    - flutter doctor -v
    - flutter pub get
    - flutter build appbundle --flavor env_release -t lib/main_env_release.dart --no-tree-shake-icons --release
  artifacts:
    paths:
      - build/app/outputs/bundle/**/*.aab
    expire_in: 90 days
  only:
    - tags
  when: manual

# 发布到 GitLab Release
release:
  stage: release
  image: alpine:latest
  dependencies:
    - build-android-release
  script:
    - |
      VERSION=$(grep -E '^version:' pubspec.yaml | sed 's/version: //')
      VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
      echo "发布版本: $VERSION_NAME"
    - apk add --no-cache curl
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --form "name=版本 $VERSION_NAME" \
        --form "tag_name=$CI_COMMIT_TAG" \
        --form "description=自动构建的发布版本" \
        --form "assets[links][][name]=APK" \
        --form "assets[links][][url]=$CI_JOB_URL/artifacts/file/build/app/outputs/flutter-apk/app-env_release-release.apk" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  when: manual
